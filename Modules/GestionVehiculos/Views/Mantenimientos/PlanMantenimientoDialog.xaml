<Window x:Class="GestLog.Modules.GestionVehiculos.Views.Mantenimientos.PlanMantenimientoDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:GestLog.Converters"
        Title="Configurar plan de mantenimiento"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        SizeToContent="Manual"
        Width="980"
        Height="720"
        WindowStartupLocation="Manual"
        ShowInTaskbar="False"
        Style="{StaticResource ModalWindowBase}">

    <Window.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:BooleanToOpacityConverter x:Key="BooleanToOpacityConverter" />
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter" />
    </Window.Resources>

    <Grid x:Name="RootGrid" Background="#80000000" MouseLeftButtonDown="Overlay_MouseLeftButtonDown">
        <Border Background="{StaticResource SurfaceBrush}" CornerRadius="12" Padding="0"
                Width="980" Height="720"
                HorizontalAlignment="Center" VerticalAlignment="Center"
                BorderThickness="0" Effect="{StaticResource WindowShadow}" MouseLeftButtonDown="Panel_MouseLeftButtonDown"
                Style="{StaticResource ModalCardStyle}">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Background="{StaticResource PrimaryBrush}" CornerRadius="12,12,0,0" Padding="24,20" Effect="{StaticResource HeaderShadow}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <Border Background="White" BorderThickness="0" CornerRadius="8" Padding="8" Margin="0,0,16,0" Width="44" Height="44" Effect="{StaticResource SectionShadow}">
                                <TextBlock Text="游" FontSize="18" HorizontalAlignment="Center" VerticalAlignment="Center" Style="{StaticResource ModalTextBlockBase}"/>
                            </Border>
                            <StackPanel VerticalAlignment="Center">
                                <TextBlock Text="Configurar plan preventivo" Style="{StaticResource HeaderTextStyle}" Foreground="White"/>
                                <TextBlock Text="Define plantilla, intervalos y l칤nea base" Style="{StaticResource SubHeaderTextStyle}" Foreground="White" Opacity="0.95" Margin="0,3,0,0"/>
                            </StackPanel>
                        </StackPanel>

                        <Button Grid.Column="1" x:Name="BtnCloseHeader" Style="{StaticResource CloseButton}" Click="BtnCancel_Click" ToolTip="Cerrar (Esc)" HorizontalAlignment="Right" VerticalAlignment="Center">
                            <Grid Width="14" Height="14">
                                <Line X1="0" Y1="0" X2="14" Y2="14" Stroke="White" StrokeThickness="2" StrokeStartLineCap="Round" StrokeEndLineCap="Round"/>
                                <Line X1="14" Y1="0" X2="0" Y2="14" Stroke="White" StrokeThickness="2" StrokeStartLineCap="Round" StrokeEndLineCap="Round"/>
                            </Grid>
                        </Button>
                    </Grid>
                </Border>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="24">
                        <Border Style="{StaticResource CardSectionStyle}">
                            <StackPanel>
                                <TextBlock Text="Datos del plan" Style="{StaticResource SectionHeaderStyle}" />

                                <Grid Margin="0,0,0,12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="140" />
                                        <ColumnDefinition Width="240" />
                                        <ColumnDefinition Width="20" />
                                        <ColumnDefinition Width="140" />
                                        <ColumnDefinition Width="240" />
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="Placa:" Style="{StaticResource LabelTextStyle}" VerticalAlignment="Center" />
                                    <TextBox Grid.Column="1" Text="{Binding FilterPlaca}" IsReadOnly="True" Style="{StaticResource ModernTextBoxStyle}" Margin="0" />

                                    <TextBlock Grid.Column="3" Text="Fecha inicio:" Style="{StaticResource LabelTextStyle}" VerticalAlignment="Center" />
                                    <DatePicker Grid.Column="4" SelectedDate="{Binding FechaInicioPlan}" Style="{StaticResource ModernDatePickerStyle}" />
                                </Grid>

                                <TextBlock Text="Plantillas (selecciona y personaliza)" Style="{StaticResource LabelTextStyle}" Margin="0,0,0,6" />
                                <Border Background="#F5F9F6" BorderBrush="#D8EADC" BorderThickness="1" CornerRadius="6" Padding="10,6" Margin="0,0,0,8">
                                    <TextBlock Text="{Binding PlantillaSeleccionadaResumen}" Foreground="#2E5E39" FontSize="11" TextWrapping="Wrap" />
                                </Border>

                                <TextBlock Text="Despliega cada plantilla para personalizar sus valores." FontSize="10" Foreground="#7A7A7A" Margin="0,0,0,6" />

                                <ListBox ItemsSource="{Binding PlantillasSeleccionables}" MinHeight="180" MaxHeight="280" BorderBrush="#E5E5E5" BorderThickness="1" Margin="0,0,0,12">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border Padding="4" BorderBrush="#F0F0F0" BorderThickness="0,0,0,1"
                                                    Visibility="{Binding IsVisibleWhenEditing, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <Expander IsExpanded="{Binding IsExpanded}" Background="Transparent">
                                                    <Expander.Header>
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="420" />
                                                                <ColumnDefinition Width="*" />
                                                            </Grid.ColumnDefinitions>

                                                            <CheckBox Grid.Column="0" IsChecked="{Binding IsSelected}" VerticalAlignment="Center">
                                                                <TextBlock>
                                                                    <Run Text="{Binding NombrePlantilla}" FontWeight="SemiBold" />
                                                                    <Run Text="  (Base " Foreground="#7A7A7A" />
                                                                    <Run Text="{Binding IntervaloKmBase, StringFormat={}{0:N0} km}" Foreground="#7A7A7A" />
                                                                    <Run Text=" / " Foreground="#7A7A7A" />
                                                                    <Run Text="{Binding IntervaloDiasBase, StringFormat={}{0} d칤as}" Foreground="#7A7A7A" />
                                                                    <Run Text=")" Foreground="#7A7A7A" />
                                                                </TextBlock>
                                                            </CheckBox>

                                                            <TextBlock Grid.Column="1" Text="{Binding PlanIdExistente, StringFormat=Plan actual: {0}}" Foreground="#7A7A7A" FontSize="11" VerticalAlignment="Center" HorizontalAlignment="Right" />
                                                        </Grid>
                                                    </Expander.Header>

                                                    <Border Margin="26,6,4,6" Padding="8" Background="#FAFAFA" BorderBrush="#EAEAEA" BorderThickness="1" CornerRadius="6"
                                                            IsEnabled="{Binding IsSelected}">
                                                        <StackPanel>
                                                            <Grid Margin="0,0,0,6">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="120" />
                                                                    <ColumnDefinition Width="120" />
                                                                    <ColumnDefinition Width="140" />
                                                                    <ColumnDefinition Width="140" />
                                                                </Grid.ColumnDefinitions>
                                                                <TextBlock Grid.Column="0" Text="Cada cu치ntos KM" FontSize="10" Foreground="#504F4E" HorizontalAlignment="Center" />
                                                                <TextBlock Grid.Column="1" Text="Cada cu치ntos d칤as" FontSize="10" Foreground="#504F4E" HorizontalAlignment="Center" />
                                                                <TextBlock Grid.Column="2" Text="KM del 칰ltimo cambio" FontSize="10" Foreground="#504F4E" HorizontalAlignment="Center" />
                                                                <TextBlock Grid.Column="3" Text="Fecha del 칰ltimo cambio" FontSize="10" Foreground="#504F4E" HorizontalAlignment="Center" />
                                                            </Grid>

                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="120" />
                                                                    <ColumnDefinition Width="120" />
                                                                    <ColumnDefinition Width="140" />
                                                                    <ColumnDefinition Width="140" />
                                                                </Grid.ColumnDefinitions>

                                                                <TextBox Grid.Column="0" Text="{Binding IntervaloKMPersonalizadoInput, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBoxStyle}" Margin="0,0,6,0" VerticalContentAlignment="Center" ToolTip="KM personalizado (opcional)" />
                                                                <TextBox Grid.Column="1" Text="{Binding IntervaloDiasPersonalizadoInput, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBoxStyle}" Margin="0,0,6,0" VerticalContentAlignment="Center" ToolTip="D칤as personalizados (opcional)" />
                                                                <TextBox Grid.Column="2" Text="{Binding UltimoKMRegistradoInput, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBoxStyle}" Margin="0,0,6,0" VerticalContentAlignment="Center" ToolTip="칔ltimo KM de esta plantilla" />
                                                                <DatePicker Grid.Column="3" SelectedDate="{Binding UltimaFechaMantenimiento, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernDatePickerStyle}" ToolTip="칔ltima fecha de mantenimiento de esta plantilla" />
                                                            </Grid>
                                                        </StackPanel>
                                                    </Border>
                                                </Expander>
                                            </Border>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>

                                <Border Background="#FFF8E1" BorderBrush="#F0DFA5" BorderThickness="1" CornerRadius="6" Padding="10" Margin="0,4,0,0">
                                    <TextBlock Foreground="#7A6226" FontSize="11" TextWrapping="Wrap"
                                               Text="Cada plantilla tiene su propio 칰ltimo KM y 칰ltima fecha. No tienen que coincidir entre s칤." />
                                </Border>
                            </StackPanel>
                        </Border>

                        <Border Style="{StaticResource CardSectionStyle}">
                            <StackPanel>
                                <TextBlock Text="Planes asignados" Style="{StaticResource SectionHeaderStyle}" />
                                <TextBlock Text="{Binding PlanesConfiguradosResumen}" Foreground="#7A7A7A" FontSize="11" Margin="0,0,0,8" TextWrapping="Wrap" />
                                <ListBox ItemsSource="{Binding Planes}" SelectedItem="{Binding SelectedPlan}" MinHeight="130" MaxHeight="220" BorderBrush="#E5E5E5" BorderThickness="1">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border Padding="8" BorderBrush="#F0F0F0" BorderThickness="0,0,0,1">
                                                <StackPanel>
                                                    <TextBlock FontWeight="SemiBold" Foreground="#118938" Text="{Binding PlantillaNombre}" />
                                                    <TextBlock FontSize="11" Foreground="#504F4E" Text="{Binding EstadoPlan, StringFormat=Estado: {0}}" />
                                                    <TextBlock FontSize="11" Foreground="#7A7A7A" Text="{Binding ProximoKMEjecucion, StringFormat=Pr칩x. KM: {0:N0}}" />
                                                    <TextBlock FontSize="11" Foreground="#7A7A7A" Text="{Binding ProximaFechaEjecucion, StringFormat=Pr칩x. Fecha: {0:dd/MM/yyyy}}" />
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>

                                <StackPanel Orientation="Horizontal" Margin="0,10,0,8">
                                    <Button Content="Nuevo plan" Style="{StaticResource GhostButton}" Command="{Binding PrepararNuevoPlanCommand}" Margin="0,0,8,0" />
                                </StackPanel>

                                <TextBlock Text="Estado actual" Style="{StaticResource SectionHeaderStyle}" Margin="0,4,0,4" />
                                <Border Background="#F8F8F8" CornerRadius="6" Padding="10" BorderBrush="#E5E5E5" BorderThickness="1">
                                    <TextBlock Text="{Binding PlanActualResumen}" Foreground="#504F4E" FontSize="11" TextWrapping="Wrap" />
                                </Border>
                            </StackPanel>
                        </Border>

                        <Border Background="#FFEBEE" CornerRadius="6" Padding="12" Margin="0,0,0,12"
                                Visibility="{Binding ErrorMessage, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <TextBlock Text="{Binding ErrorMessage}" Foreground="#C0392B" FontSize="12" TextWrapping="Wrap" />
                        </Border>

                        <Border Background="#E8F5E9" CornerRadius="6" Padding="12" Margin="0,0,0,12"
                                Visibility="{Binding SuccessMessage, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <TextBlock Text="{Binding SuccessMessage}" Foreground="#10B981" FontSize="12" TextWrapping="Wrap" />
                        </Border>
                    </StackPanel>
                </ScrollViewer>

                <Border Grid.Row="2" Background="#FFFFFF" BorderBrush="#EAEAEA" BorderThickness="1,1,1,0" Padding="16" CornerRadius="0,0,12,12">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Cancelar" Style="{StaticResource GhostButton}" Margin="0,0,8,0" Click="BtnCancel_Click" />
                        <!-- s칩lo mostrar bot칩n de eliminar cuando estamos editando un 칰nico plan -->
                        <Button Content="游딈 Eliminar" Style="{StaticResource GhostButton}" Margin="0,0,8,0"
                                Foreground="#C0392B" Command="{Binding DeletePlanCommand}"
                                CommandParameter="{Binding SelectedPlan}"
                                Visibility="{Binding IsEditingSinglePlan, Converter={StaticResource BooleanToVisibilityConverter}}" />
                        <Button Content="Guardar plan" Style="{StaticResource PrimaryButtonStyle}" Command="{Binding GuardarPlanVehiculoCommand}"
                            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}" />
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</Window>
