<Window x:Class="GestLog.Modules.GestionVehiculos.Views.Mantenimientos.PlanMantenimientoDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:GestLog.Converters"
        Title="Configurar plan de mantenimiento"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        SizeToContent="Manual"
        Width="1100"
        Height="720"
        WindowStartupLocation="Manual"
        ShowInTaskbar="False"
        Style="{StaticResource ModalWindowBase}">

    <Window.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:BooleanToOpacityConverter x:Key="BooleanToOpacityConverter" />
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter" />
    </Window.Resources>

    <Grid x:Name="RootGrid" Background="#80000000" MouseLeftButtonDown="Overlay_MouseLeftButtonDown">
        <Border Background="{StaticResource SurfaceBrush}" CornerRadius="12" Padding="0"
                Width="1100" Height="720"
                HorizontalAlignment="Center" VerticalAlignment="Center"
                BorderThickness="0" Effect="{StaticResource WindowShadow}" MouseLeftButtonDown="Panel_MouseLeftButtonDown"
                Style="{StaticResource ModalCardStyle}">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Background="{StaticResource PrimaryBrush}" CornerRadius="12,12,0,0" Padding="24,20" Effect="{StaticResource HeaderShadow}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <Border Background="White" BorderThickness="0" CornerRadius="8" Padding="8" Margin="0,0,16,0" Width="44" Height="44" Effect="{StaticResource SectionShadow}">
                                <TextBlock Text="ðŸ› " FontSize="18" HorizontalAlignment="Center" VerticalAlignment="Center" Style="{StaticResource ModalTextBlockBase}"/>
                            </Border>
                            <StackPanel VerticalAlignment="Center">
                                <TextBlock Text="Configurar plan preventivo" Style="{StaticResource HeaderTextStyle}" Foreground="White"/>
                                <TextBlock Text="Define plantilla, intervalos y lÃ­nea base" Style="{StaticResource SubHeaderTextStyle}" Foreground="White" Opacity="0.95" Margin="0,3,0,0"/>
                            </StackPanel>
                        </StackPanel>

                        <Button Grid.Column="1" x:Name="BtnCloseHeader" Style="{StaticResource CloseButton}" Click="BtnCancel_Click" ToolTip="Cerrar (Esc)" HorizontalAlignment="Right" VerticalAlignment="Center">
                            <Grid Width="14" Height="14">
                                <Line X1="0" Y1="0" X2="14" Y2="14" Stroke="White" StrokeThickness="2" StrokeStartLineCap="Round" StrokeEndLineCap="Round"/>
                                <Line X1="14" Y1="0" X2="0" Y2="14" Stroke="White" StrokeThickness="2" StrokeStartLineCap="Round" StrokeEndLineCap="Round"/>
                            </Grid>
                        </Button>
                    </Grid>
                </Border>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <Grid Margin="24">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="340" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- plantillas card list -->
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Plantillas" Style="{StaticResource SectionHeaderStyle}" />
                            <TextBlock Text="Selecciona una plantilla para configurar o editar un plan." Foreground="#7A7A7A" FontSize="11" Margin="0,0,0,8" TextWrapping="Wrap" />

                            <ItemsControl ItemsSource="{Binding PlantillasSeleccionables}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Width="140" Height="160" Padding="8" Margin="6" Background="#FFFFFF" BorderBrush="#E5E5E5" BorderThickness="1" CornerRadius="6"
                                                Visibility="{Binding IsVisibleWhenEditing, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <Grid>
                                                <StackPanel>
                                                    <Grid Margin="0,0,0,2">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*" />
                                                            <ColumnDefinition Width="24" />
                                                        </Grid.ColumnDefinitions>
                                                        <TextBlock Grid.Column="0" Text="{Binding NombrePlantilla}" FontWeight="SemiBold" TextWrapping="Wrap" Margin="0,0,6,0" />
                                                        <Border Grid.Column="1" Width="20" Height="20" CornerRadius="10" Background="#E8F5E9" BorderBrush="#118938" BorderThickness="1"
                                                                HorizontalAlignment="Right" VerticalAlignment="Top"
                                                                Visibility="{Binding IsSelected, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                            <TextBlock Text="âœ“" Foreground="#118938" FontSize="12" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                        </Border>
                                                    </Grid>
                                                    <TextBlock Text="{Binding IntervaloKMAplicado, StringFormat={}{0:N0} km}" FontSize="10" Foreground="#7A7A7A" />
                                                    <TextBlock Text="{Binding IntervaloDiasAplicado, StringFormat={}{0} dÃ­as}" FontSize="10" Foreground="#7A7A7A" />
                                                    <TextBlock Text="{Binding NextKmPreview, StringFormat=PrÃ³x. km: {0:N0}}" FontSize="10" Foreground="#7A7A7A" />
                                                    <Button Content="Configurar" Style="{StaticResource GhostButton}" Margin="0,8,0,0"
                                                            Command="{Binding DataContext.SelectTemplateCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                            CommandParameter="{Binding}" />
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- details and assigned plans -->
                        <StackPanel Grid.Column="1" Margin="12,0,0,0">
                            <Border Background="#FAFAFA" Padding="12" CornerRadius="6" Visibility="{Binding IsDetailVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <StackPanel>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="{Binding SelectedTemplate.NombrePlantilla}" FontSize="16" FontWeight="SemiBold" />
                                        <Button Grid.Column="1" Content="âœ•" Style="{StaticResource GhostButton}" Width="24" Height="24" Margin="8,0,0,0"
                                                Command="{Binding DeselectTemplateCommand}"
                                                CommandParameter="{Binding SelectedTemplate}"
                                                ToolTip="Deseleccionar plantilla" />
                                    </Grid>
                                    <TextBlock FontSize="12" Foreground="#504F4E" Margin="0,4,0,12">
                                        <Run Text="{Binding SelectedTemplate.IntervaloKMAplicado, StringFormat={}{0:N0} km}" />
                                        <Run Text="  /  " />
                                        <Run Text="{Binding SelectedTemplate.IntervaloDiasAplicado, StringFormat={}{0} dÃ­as}" />
                                    </TextBlock>

                                    <!-- customization fields -->
                                    <Grid Margin="0,0,0,6">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="120" />
                                            <ColumnDefinition Width="120" />
                                            <ColumnDefinition Width="140" />
                                            <ColumnDefinition Width="140" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" Text="Cada cuÃ¡ntos KM" FontSize="10" Foreground="#504F4E" HorizontalAlignment="Center" />
                                        <TextBlock Grid.Column="1" Text="Cada cuÃ¡ntos dÃ­as" FontSize="10" Foreground="#504F4E" HorizontalAlignment="Center" />
                                        <TextBlock Grid.Column="2" Text="KM del Ãºltimo cambio" FontSize="10" Foreground="#504F4E" HorizontalAlignment="Center" />
                                        <TextBlock Grid.Column="3" Text="Fecha del Ãºltimo cambio" FontSize="10" Foreground="#504F4E" HorizontalAlignment="Center" />
                                    </Grid>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="120" />
                                            <ColumnDefinition Width="120" />
                                            <ColumnDefinition Width="140" />
                                            <ColumnDefinition Width="140" />
                                        </Grid.ColumnDefinitions>

                                        <TextBox Grid.Column="0" Text="{Binding SelectedTemplate.IntervaloKMPersonalizadoInput, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBoxStyle}" Margin="0,0,6,0" VerticalContentAlignment="Center" ToolTip="KM personalizado (opcional)" />
                                        <TextBox Grid.Column="1" Text="{Binding SelectedTemplate.IntervaloDiasPersonalizadoInput, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBoxStyle}" Margin="0,0,6,0" VerticalContentAlignment="Center" ToolTip="DÃ­as personalizados (opcional)" />
                                        <TextBox Grid.Column="2" Text="{Binding SelectedTemplate.UltimoKMRegistradoInput, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBoxStyle}" Margin="0,0,6,0" VerticalContentAlignment="Center" ToolTip="Ãšltimo KM de esta plantilla" />
                                        <DatePicker Grid.Column="3" SelectedDate="{Binding SelectedTemplate.UltimaFechaMantenimiento, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernDatePickerStyle}" ToolTip="Ãšltima fecha de mantenimiento de esta plantilla" />
                                    </Grid>
                                    <TextBlock Text="{Binding SelectedTemplate.NextKmFormula}" FontSize="10" Foreground="#504F4E" Margin="0,4,0,0" />
                                </StackPanel>
                            </Border>

                            <Border Style="{StaticResource CardSectionStyle}" Margin="0,12,0,0">
                                <StackPanel>
                                    <TextBlock Text="Planes asignados" Style="{StaticResource SectionHeaderStyle}" />
                                    <!-- cards instead of listbox -->
                                    <ItemsControl ItemsSource="{Binding Planes}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Width="220" Padding="10" Margin="4" CornerRadius="6" BorderThickness="1"
                                                        Background="#FFFFFF" BorderBrush="#E5E5E5">
                                                    <StackPanel>
                                                        <TextBlock FontWeight="SemiBold" Foreground="#118938" Text="{Binding PlantillaNombre}" TextWrapping="Wrap" />
                                                        <TextBlock FontSize="11" Foreground="#504F4E" Text="{Binding EstadoPlan}" />
                                                        <TextBlock FontSize="11" Foreground="#7A7A7A" Text="{Binding ProximoKMEjecucion, StringFormat=PrÃ³x. KM: {0:N0}}" />
                                                        <TextBlock FontSize="11" Foreground="#7A7A7A" Text="{Binding ProximaFechaEjecucion, StringFormat=PrÃ³x. Fecha: {0:dd/MM/yyyy}}" />
                                                        <Grid Margin="0,8,0,0">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*" />
                                                                <ColumnDefinition Width="*" />
                                                            </Grid.ColumnDefinitions>
                                                            <Button Grid.Column="0" Content="Editar" Style="{StaticResource GhostButton}"
                                                                    Command="{Binding DataContext.EditPlanCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    CommandParameter="{Binding}" Margin="0,0,4,0" MinWidth="88" Height="30" />
                                                            <Button Grid.Column="1" Content="Eliminar" Style="{StaticResource GhostButton}"
                                                                    Command="{Binding DataContext.DeletePlanCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    CommandParameter="{Binding}" Margin="4,0,0,0" Foreground="#C0392B" MinWidth="88" Height="30" />
                                                        </Grid>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    
                                    <TextBlock Text="Estado actual" Style="{StaticResource SectionHeaderStyle}" Margin="0,4,0,4" />
                                    <Border Background="#F8F8F8" CornerRadius="6" Padding="10" BorderBrush="#E5E5E5" BorderThickness="1">
                                        <TextBlock Text="{Binding PlanActualResumen}" Foreground="#504F4E" FontSize="11" TextWrapping="Wrap" />
                                    </Border>
                                </StackPanel>
                            </Border>

                            <Border Background="#FFEBEE" CornerRadius="6" Padding="12" Margin="0,0,0,12"
                                    Visibility="{Binding ErrorMessage, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock Text="{Binding ErrorMessage}" Foreground="#C0392B" FontSize="12" TextWrapping="Wrap" />
                            </Border>

                            <Border Background="#E8F5E9" CornerRadius="6" Padding="12" Margin="0,0,0,12"
                                    Visibility="{Binding SuccessMessage, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock Text="{Binding SuccessMessage}" Foreground="#10B981" FontSize="12" TextWrapping="Wrap" />
                            </Border>
                        </StackPanel>
                    </Grid>
                </ScrollViewer>

                <Border Grid.Row="2" Background="#FFFFFF" BorderBrush="#EAEAEA" BorderThickness="1,1,1,0" Padding="16" CornerRadius="0,0,12,12">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Cancelar" Style="{StaticResource GhostButton}" Margin="0,0,8,0" Click="BtnCancel_Click" />
                        <!-- sÃ³lo mostrar botÃ³n de eliminar cuando estamos editando un Ãºnico plan -->
                        <Button Content="ðŸ—‘ Eliminar" Style="{StaticResource GhostButton}" Margin="0,0,8,0"
                                Foreground="#C0392B" Command="{Binding DeletePlanCommand}"
                                CommandParameter="{Binding SelectedPlan}"
                                Visibility="{Binding IsEditingSinglePlan, Converter={StaticResource BooleanToVisibilityConverter}}" />
                        <Button Content="Guardar plan" Style="{StaticResource PrimaryButtonStyle}" Command="{Binding GuardarPlanVehiculoCommand}"
                            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}" />
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</Window>
