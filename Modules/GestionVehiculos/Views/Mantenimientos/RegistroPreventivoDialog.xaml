<Window x:Class="GestLog.Modules.GestionVehiculos.Views.Mantenimientos.RegistroPreventivoDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:GestLog.Converters"
        Title="Registrar preventivo"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        SizeToContent="Manual"
        Width="1280"
        Height="860"
        WindowStartupLocation="Manual"
        ShowInTaskbar="False"
        Style="{StaticResource ModalWindowBase}">

    <Window.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:BooleanToOpacityConverter x:Key="BooleanToOpacityConverter" />
    </Window.Resources>

    <Grid x:Name="RootGrid" Background="#80000000" MouseLeftButtonDown="Overlay_MouseLeftButtonDown">
        <Border Background="{StaticResource SurfaceBrush}" CornerRadius="12" Padding="0"
                MaxWidth="1320" MaxHeight="900" Margin="20"
                HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                BorderThickness="0" Effect="{StaticResource WindowShadow}" MouseLeftButtonDown="Panel_MouseLeftButtonDown"
                Style="{StaticResource ModalCardStyle}">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Background="{StaticResource PrimaryBrush}" CornerRadius="12,12,0,0" Padding="24,20" Effect="{StaticResource HeaderShadow}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <Border Background="White" BorderThickness="0" CornerRadius="8" Padding="8" Margin="0,0,16,0" Width="44" Height="44" Effect="{StaticResource SectionShadow}">
                                <TextBlock Text="✅" FontSize="18" HorizontalAlignment="Center" VerticalAlignment="Center" Style="{StaticResource ModalTextBlockBase}"/>
                            </Border>
                            <StackPanel VerticalAlignment="Center">
                                <TextBlock Text="Registrar preventivo" Style="{StaticResource HeaderTextStyle}" Foreground="White"/>
                                <TextBlock Text="Planes a registrar y datos comunes" Style="{StaticResource SubHeaderTextStyle}" Foreground="White" Opacity="0.95" Margin="0,3,0,0"/>
                            </StackPanel>
                        </StackPanel>

                        <Button Grid.Column="1" x:Name="BtnCloseHeader" Style="{StaticResource CloseButton}" Click="BtnCancel_Click" ToolTip="Cerrar (Esc)" HorizontalAlignment="Right" VerticalAlignment="Center">
                            <Grid Width="14" Height="14">
                                <Line X1="0" Y1="0" X2="14" Y2="14" Stroke="White" StrokeThickness="2" StrokeStartLineCap="Round" StrokeEndLineCap="Round"/>
                                <Line X1="14" Y1="0" X2="0" Y2="14" Stroke="White" StrokeThickness="2" StrokeStartLineCap="Round" StrokeEndLineCap="Round"/>
                            </Grid>
                        </Button>
                    </Grid>
                </Border>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="24">
                        <Border Style="{StaticResource CardSectionStyle}">
                            <StackPanel>
                                <TextBlock Text="Plan y ventana" Style="{StaticResource SectionHeaderStyle}" />
                                <Border Background="#F3F9F3" BorderBrush="#D8EADC" BorderThickness="1" CornerRadius="6" Padding="10">
                                    <StackPanel>
                                        <TextBlock Text="Tipo: Preventivo" Foreground="#2E5E39" FontSize="11" FontWeight="SemiBold" />
                                        <TextBlock Text="{Binding PlanPreventivoInfo}" Foreground="#2E5E39" FontSize="11" Margin="0,4,0,0" TextWrapping="Wrap" />
                                        <TextBlock Text="{Binding VentanaPreventivoInfo}" FontSize="11" Margin="0,4,0,0" TextWrapping="Wrap">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="#2E5E39"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding VentanaPreventivoAdvertencia}" Value="True">
                                                            <Setter Property="Foreground" Value="#C0392B"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>

                        <Border Style="{StaticResource CardSectionStyle}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="0.44*" />
                                    <ColumnDefinition Width="16" />
                                    <ColumnDefinition Width="0.56*" />
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Planes a registrar" Style="{StaticResource SectionHeaderStyle}" />
                                    <TextBlock Text="Selecciona uno o varios planes. El detalle por plan es opcional." FontSize="11" Foreground="#9D9D9C" Margin="0,0,0,8" TextWrapping="Wrap" />

                                    <Border Background="#F5F9F6" BorderBrush="#D8EADC" BorderThickness="1" CornerRadius="6" Padding="8" Margin="0,0,0,8">
                                        <TextBlock Text="{Binding PlanesSeleccionadosResumen}" FontSize="11" Foreground="#2E5E39" />
                                    </Border>

                                    <ListBox ItemsSource="{Binding PlanesPreventivoSeleccionables}" MinHeight="260" MaxHeight="340" BorderBrush="#E5E5E5" BorderThickness="1" IsEnabled="{Binding HasPlanPreventivo}">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <Border Padding="8" BorderBrush="#F0F0F0" BorderThickness="0,0,0,1">
                                                    <StackPanel>
                                                        <CheckBox IsChecked="{Binding IsSelected}" FontWeight="SemiBold" Content="{Binding NombrePlantilla}" />

                                                        <Border Margin="20,4,0,0" Padding="6,2" CornerRadius="10" HorizontalAlignment="Left">
                                                            <Border.Style>
                                                                <Style TargetType="Border">
                                                                    <Setter Property="Background" Value="#E8F5E9" />
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding EstadoPlan}" Value="Vencido">
                                                                            <Setter Property="Background" Value="#FFEBEE" />
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding EstadoPlan}" Value="Próximo">
                                                                            <Setter Property="Background" Value="#FFF8E1" />
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding EstadoPlan}" Value="Vigente">
                                                                            <Setter Property="Background" Value="#E8F5E9" />
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Border.Style>
                                                            <TextBlock Text="{Binding EstadoVisual}" FontSize="10" FontWeight="SemiBold">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Foreground" Value="#2E7D32" />
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding EstadoPlan}" Value="Vencido">
                                                                                <Setter Property="Foreground" Value="#C0392B" />
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding EstadoPlan}" Value="Próximo">
                                                                                <Setter Property="Foreground" Value="#B7791F" />
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding EstadoPlan}" Value="Vigente">
                                                                                <Setter Property="Foreground" Value="#2E7D32" />
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                        </Border>

                                                        <TextBlock Text="{Binding ProximoKMEjecucion, StringFormat=Próx. KM: {0:N0}}" FontSize="10" Foreground="#7A7A7A" Margin="20,2,0,0" />
                                                        <TextBlock Text="{Binding ProximaFechaEjecucion, StringFormat=Próx. fecha: {0:dd/MM/yyyy}}" FontSize="10" Foreground="#7A7A7A" Margin="20,2,0,0" />

                                                        <Border Margin="20,8,0,0"
                                                                Visibility="{Binding IsSelected, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                Background="#F7F9FB"
                                                                BorderBrush="#DDE5EC"
                                                                BorderThickness="1"
                                                                CornerRadius="6"
                                                                Padding="8">
                                                            <StackPanel>
                                                                <TextBlock Text="Nota específica de este plan (opcional)"
                                                                           FontSize="10"
                                                                           FontWeight="SemiBold"
                                                                           Foreground="#504F4E" />
                                                                <TextBlock Text="Ejemplo: cambio de marca, observación técnica, pendiente para próxima revisión."
                                                                           FontSize="9"
                                                                           Foreground="#7A7A7A"
                                                                           Margin="0,2,0,6"
                                                                           TextWrapping="Wrap" />
                                                                <TextBox Text="{Binding DetalleOpcional, UpdateSourceTrigger=PropertyChanged}"
                                                                         MinHeight="56"
                                                                         Style="{StaticResource ModernTextBoxStyle}"
                                                                         TextWrapping="Wrap"
                                                                         AcceptsReturn="True" />
                                                            </StackPanel>
                                                        </Border>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </StackPanel>

                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="Datos comunes de ejecución" Style="{StaticResource SectionHeaderStyle}" />
                                    <TextBlock Text="Estos datos se aplican a todos los planes seleccionados." FontSize="11" Foreground="#9D9D9C" Margin="0,0,0,8" TextWrapping="Wrap" />

                                    <Grid Margin="0,8,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="16" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="Fecha ejecución" Style="{StaticResource LabelTextStyle}" Margin="0,0,0,4" />
                                            <DatePicker SelectedDate="{Binding RegistroFechaEjecucion}" Style="{StaticResource ModernDatePickerStyle}" />
                                            <TextBlock Text="{Binding FechaValidationMessage}" Foreground="#C0392B" FontSize="10" Margin="0,4,0,0">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding FechaValidationMessage}" Value="">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </StackPanel>

                                        <StackPanel Grid.Column="2">
                                            <TextBlock Text="Kilometraje actual al hacer el mantenimiento" Style="{StaticResource LabelTextStyle}" Margin="0,0,0,4" TextWrapping="Wrap" />
                                            <TextBox Text="{Binding RegistroKMAlMomentoInput, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBoxStyle}" Margin="0" />
                                            <TextBlock Text="{Binding KmValidationMessage}" Foreground="#C0392B" FontSize="10" Margin="0,4,0,0">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding KmValidationMessage}" Value="">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </StackPanel>
                                    </Grid>

                                    <Button Content="Tomar KM actual" Command="{Binding CargarKilometrajeActualCommand}"
                                            Style="{StaticResource PrimaryButtonStyle}" FontSize="12" Padding="10,6" Margin="0,8,0,0" Width="150"
                                            IsEnabled="{Binding HasPlanPreventivo}" />

                                    <Grid Margin="0,8,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="16" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="Responsable" Style="{StaticResource LabelTextStyle}" Margin="0,0,0,4" />
                                            <TextBox Text="{Binding RegistroResponsable, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBoxStyle}" Margin="0" />
                                            <TextBlock Text="{Binding ResponsableValidationMessage}" Foreground="#C0392B" FontSize="10" Margin="0,4,0,0">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ResponsableValidationMessage}" Value="">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </StackPanel>

                                        <StackPanel Grid.Column="2">
                                            <TextBlock Text="Costo total del servicio" Style="{StaticResource LabelTextStyle}" Margin="0,0,0,4" />
                                            <TextBox Text="{Binding RegistroCostoInput, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBoxStyle}" Margin="0" />
                                            <TextBlock Text="{Binding CostoValidationMessage}" Foreground="#C0392B" FontSize="10" Margin="0,4,0,0">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding CostoValidationMessage}" Value="">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                            <TextBlock Text="Si eliges varios planes, este valor se reparte automáticamente entre los planes seleccionados."
                                                       FontSize="10"
                                                       Foreground="#7A7A7A"
                                                       Margin="0,4,0,0"
                                                       TextWrapping="Wrap"/>
                                        </StackPanel>
                                    </Grid>

                                    <StackPanel Margin="0,8,0,0">
                                        <TextBlock Text="Observación general" Style="{StaticResource LabelTextStyle}" Margin="0,0,0,4" />
                                        <TextBox Text="{Binding RegistroObservaciones, UpdateSourceTrigger=PropertyChanged}" MinHeight="90" Style="{StaticResource ModernTextBoxStyle}" Margin="0" TextWrapping="Wrap" AcceptsReturn="True" />
                                    </StackPanel>

                                    <Border Margin="0,10,0,0" Background="#EFF6FF" BorderBrush="#BFDBFE" BorderThickness="1" CornerRadius="8" Padding="10">
                                        <StackPanel>
                                            <TextBlock Text="Resumen previo de guardado" FontSize="11" FontWeight="SemiBold" Foreground="#1E3A8A" />
                                            <TextBlock Text="{Binding ResumenPrevioGuardado}" Margin="0,4,0,0" FontSize="11" Foreground="#1E3A8A" TextWrapping="Wrap" />
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <Border Background="#FFEBEE" CornerRadius="6" Padding="12" Margin="0,0,0,12"
                                Visibility="{Binding ErrorMessage, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <TextBlock Text="{Binding ErrorMessage}" Foreground="#C0392B" FontSize="12" TextWrapping="Wrap" />
                        </Border>

                        <Border Background="#E8F5E9" CornerRadius="6" Padding="12" Margin="0,0,0,12"
                                Visibility="{Binding SuccessMessage, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <TextBlock Text="{Binding SuccessMessage}" Foreground="#10B981" FontSize="12" TextWrapping="Wrap" />
                        </Border>
                    </StackPanel>
                </ScrollViewer>

                <Border Grid.Row="2" Background="#FFFFFF" BorderBrush="#EAEAEA" BorderThickness="1,1,1,0" Padding="16" CornerRadius="0,0,12,12">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Cancelar" Style="{StaticResource GhostButton}" Margin="0,0,8,0" Click="BtnCancel_Click" />
                        <Button Content="{Binding RegistrarPreventivoButtonText}" Style="{StaticResource PrimaryButtonStyle}" Command="{Binding RegistrarEjecucionCommand}"
                                IsEnabled="{Binding HasPlanesSeleccionados}" />
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</Window>
