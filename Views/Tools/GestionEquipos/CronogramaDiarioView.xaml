<UserControl xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:GestLog.Modules.GestionEquiposInformaticos.ViewModels"
             xmlns:converters="clr-namespace:GestLog.Converters"
             x:Class="GestLog.Views.Tools.GestionEquipos.CronogramaDiarioView">    <UserControl.Resources>
        <converters:CronogramaTipoToBackgroundConverter x:Key="CronogramaTipoToBackgroundConverter" />
        <converters:CronogramaTipoToBorderConverter x:Key="CronogramaTipoToBorderConverter" />
        <converters:CronogramaTipoToButtonTextConverter x:Key="CronogramaTipoToButtonTextConverter" />
        <converters:PlanEjecucionEstadoToBackgroundConverter x:Key="PlanEjecucionEstadoToBackgroundConverter" />
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <!-- Agregados: converters usados pero no definidos -->
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter" />
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter" />
        
        <!-- Efecto de sombra para el popup -->
        <DropShadowEffect x:Key="DropShadowEffect" 
                          Color="Black" 
                          Direction="315" 
                          ShadowDepth="4" 
                          Opacity="0.3" 
                          BlurRadius="8"/>
    </UserControl.Resources>
    <Border Background="#FAFAFA" Padding="12">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>            <DockPanel Grid.Row="0" Margin="0,0,0,12">
                <!-- Navegación: Selector de calendario popup -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" DockPanel.Dock="Left">
                    <!-- Botón para mostrar calendario -->
                    <Button x:Name="CalendarButton" 
                            Content="📅 Seleccionar Semana" 
                            Click="CalendarButton_Click"
                            Padding="12,6" 
                            Background="#F8F9FA" 
                            Foreground="#504F4E" 
                            BorderBrush="#504F4E" 
                            BorderThickness="1.5"
                            FontSize="11" 
                            FontWeight="Medium"
                            Cursor="Hand">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}" 
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                    CornerRadius="6"
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center" 
                                                                VerticalAlignment="Center"
                                                                Content="{TemplateBinding Content}"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#E9ECEF"/>
                                                    <Setter Property="BorderBrush" Value="#118938"/>
                                                    <Setter Property="Foreground" Value="#118938"/>
                                                </Trigger>
                                                <Trigger Property="IsPressed" Value="True">
                                                    <Setter Property="Background" Value="#DEE2E6"/>
                                                    <Setter Property="BorderBrush" Value="#0F7530"/>
                                                    <Setter Property="Foreground" Value="#0F7530"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>
                    
                    <!-- Texto que muestra la semana seleccionada -->
                    <TextBlock x:Name="SelectedWeekText" 
                               Text="Semana 1, 2024" 
                               VerticalAlignment="Center" 
                               Margin="12,0,0,0" 
                               Foreground="#333" 
                               FontWeight="Medium"/>
                    
                    <!-- Popup del calendario -->
                    <Popup x:Name="CalendarPopup" 
                           PlacementTarget="{Binding ElementName=CalendarButton}"
                           Placement="Bottom"
                           StaysOpen="False"
                           AllowsTransparency="True">
                        <Border Background="White" 
                                BorderBrush="#DDD" 
                                BorderThickness="1" 
                                CornerRadius="6"
                                Padding="12"
                                Effect="{DynamicResource DropShadowEffect}">
                            <StackPanel Width="280">                                <!-- Header del calendario -->
                                <DockPanel Margin="0,0,0,12">
                                    <Button x:Name="PrevMonthButton" 
                                            Content="‹" 
                                            DockPanel.Dock="Left"
                                            Click="PrevMonthButton_Click"
                                            Width="30" Height="30"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            FontSize="16"
                                            FontWeight="Bold"
                                            Cursor="Hand"/>
                                    <Button x:Name="NextMonthButton" 
                                            Content="›" 
                                            DockPanel.Dock="Right"
                                            Click="NextMonthButton_Click"
                                            Width="30" Height="30"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            FontSize="16"
                                            FontWeight="Bold"
                                            Cursor="Hand"/>
                                    <TextBlock x:Name="MonthYearText" 
                                               Text="Año 2024" 
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"
                                               FontWeight="Bold"/>
                                </DockPanel>
                                  <!-- Selector de semanas -->
                                <ListBox x:Name="WeekSelector"
                                         Height="200"
                                         SelectionMode="Single"
                                         SelectionChanged="WeekSelector_SelectionChanged"
                                         Background="White"
                                         BorderThickness="0">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border Padding="8,4" 
                                                    Margin="2"
                                                    CornerRadius="4"
                                                    Background="Transparent">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" 
                                                               Text="{Binding WeekNumber, StringFormat='Semana {0}'}" 
                                                               FontWeight="Bold"
                                                               Width="80"/>
                                                    <TextBlock Grid.Column="1" 
                                                               Text="{Binding DateRange}" 
                                                               Foreground="#666"
                                                               FontSize="10"/>
                                                </Grid>
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListBoxItem}, Path=IsSelected}" Value="True">
                                                                <Setter Property="Background" Value="#E3F2FD"/>
                                                                <Setter Property="BorderBrush" Value="#2196F3"/>
                                                                <Setter Property="BorderThickness" Value="1"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListBoxItem}, Path=IsMouseOver}" Value="True">
                                                                <Setter Property="Background" Value="#F5F5F5"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                            </Border>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </StackPanel>
                        </Border>
                    </Popup>
                </StackPanel>
                
                <!-- Acciones: Botones de gestión -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Right" DockPanel.Dock="Right">
                    <!-- Botón para crear nuevo plan -->
                    <Border CornerRadius="4" Margin="0,0,8,0" VerticalAlignment="Center" Background="#007ACC">
                        <Button Content="Crear Plan" Padding="8,4"
                                Command="{Binding CrearPlanCommand}" 
                                Background="Transparent" Foreground="White" BorderThickness="0" />
                    </Border>
                    
                    <!-- Botón para gestionar planes existentes -->
                    <Border CornerRadius="4" VerticalAlignment="Center" Background="#28A745">
                        <Button Content="Gestionar Planes" Padding="8,4"
                                Command="{Binding GestionarPlanesCommand}" 
                                Background="Transparent" Foreground="White" BorderThickness="0" />
                    </Border>
                </StackPanel>
            </DockPanel>

            <!-- Tablero semanal: 5 columnas (Lunes-Viernes) -->
            <!-- Eliminado ScrollViewer externo que impedía el estiramiento completo -->
            <Grid Grid.Row="1">
                <ItemsControl ItemsSource="{Binding Days}" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch" SnapsToDevicePixels="True">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Columns="5" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Margin="6" Background="White" CornerRadius="6" Padding="8" BorderBrush="#DDD" BorderThickness="1" HorizontalAlignment="Stretch">
                                <DockPanel>
                                    <TextBlock Text="{Binding Name}" FontWeight="Bold" DockPanel.Dock="Top" Margin="0,0,0,4" />
                                    <Separator DockPanel.Dock="Top" Margin="0,0,0,4" />
                                    <!-- Mover mensaje antes del ItemsControl para que éste sea el último y se expanda (LastChildFill) -->                                    <TextBlock Text="No hay mantenimientos" Foreground="#999" HorizontalAlignment="Center" DockPanel.Dock="Top" Visibility="{Binding Items.Count, Converter={StaticResource CountToVisibilityConverter}}" />
                                    <ItemsControl ItemsSource="{Binding Items}" HorizontalContentAlignment="Stretch">
                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="ContentPresenter">
                                                <Setter Property="HorizontalAlignment" Value="Stretch"/>
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Margin="0,0,0,4" Padding="4" 
                                                        Background="{Binding Converter={StaticResource PlanEjecucionEstadoToBackgroundConverter}}" 
                                                        BorderBrush="{Binding Converter={StaticResource CronogramaTipoToBorderConverter}}"
                                                        BorderThickness="1"
                                                        CornerRadius="4"
                                                        SnapsToDevicePixels="True"
                                                        UseLayoutRounding="True"
                                                        HorizontalAlignment="Stretch">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*" />
                                                            <ColumnDefinition Width="Auto" />
                                                        </Grid.ColumnDefinitions>
                                                        <StackPanel Grid.Column="0" Margin="0,0,8,0" VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding Nombre}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis" />
                                                            <TextBlock Text="{Binding Sede}" FontSize="10" Foreground="#666" TextTrimming="CharacterEllipsis" />
                                                        </StackPanel>                                                        <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">                                                            <Button Content="{Binding Converter={StaticResource CronogramaTipoToButtonTextConverter}}" 
                                                                    Margin="0,0,4,0"
                                                                    Padding="12,6"
                                                                    VerticalAlignment="Center"
                                                                    Background="#F8F9FA" 
                                                                    Foreground="#504F4E" 
                                                                    BorderBrush="#504F4E" 
                                                                    BorderThickness="1.5"
                                                                    FontSize="11" 
                                                                    FontWeight="Medium"
                                                                    Command="{Binding DataContext.OpenRegistrarCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                    CommandParameter="{Binding}"
                                                                    Cursor="Hand"
                                                                    Visibility="{Binding PlanEjecutadoSemana, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                                                                <Button.Style>
                                                                    <Style TargetType="Button">
                                                                        <Setter Property="Template">
                                                                            <Setter.Value>
                                                                                <ControlTemplate TargetType="Button">
                                                                                    <Border Background="{TemplateBinding Background}" 
                                                                                            BorderBrush="{TemplateBinding BorderBrush}"
                                                                                            BorderThickness="{TemplateBinding BorderThickness}"
                                                                                            CornerRadius="6"
                                                                                            Padding="{TemplateBinding Padding}">
                                                                                        <ContentPresenter HorizontalAlignment="Center" 
                                                                                                        VerticalAlignment="Center"
                                                                                                        Content="{TemplateBinding Content}"
                                                                                                        ContentTemplate="{TemplateBinding ContentTemplate}"/>
                                                                                    </Border>                                                                                    <ControlTemplate.Triggers>
                                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                                            <Setter Property="Background" Value="#E9ECEF"/>
                                                                                            <Setter Property="BorderBrush" Value="#118938"/>
                                                                                            <Setter Property="Foreground" Value="#118938"/>
                                                                                        </Trigger>
                                                                                        <Trigger Property="IsPressed" Value="True">
                                                                                            <Setter Property="Background" Value="#DEE2E6"/>
                                                                                            <Setter Property="BorderBrush" Value="#0F7530"/>
                                                                                            <Setter Property="Foreground" Value="#0F7530"/>
                                                                                        </Trigger>
                                                                                    </ControlTemplate.Triggers>
                                                                                </ControlTemplate>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                    </Style>
                                                                </Button.Style>
                                                            </Button>                                                            <Button Command="{Binding DataContext.VerDetallePlanCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                    CommandParameter="{Binding}"
                                                                    ToolTip="Ver detalle ejecución"
                                                                    Padding="3" Width="24" Height="24"
                                                                    Margin="0,0,10,0"
                                                                    VerticalAlignment="Center"
                                                                    Background="#118938" BorderBrush="#0F7530" BorderThickness="1" Cursor="Hand"
                                                                    Visibility="{Binding PlanEjecutadoSemana, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                                <Button.Style>
                                                                    <Style TargetType="Button">
                                                                        <Setter Property="Template">
                                                                            <Setter.Value>
                                                                                <ControlTemplate TargetType="Button">
                                                                                    <Border Background="{TemplateBinding Background}" 
                                                                                            BorderBrush="{TemplateBinding BorderBrush}"
                                                                                            BorderThickness="{TemplateBinding BorderThickness}"
                                                                                            CornerRadius="3"
                                                                                            Padding="{TemplateBinding Padding}">                                                                                        <Path Data="M3,12 L7,16 L17,6" 
                                                                                              Stroke="White" 
                                                                                              StrokeThickness="2" 
                                                                                              Stretch="Uniform"
                                                                                              HorizontalAlignment="Center"
                                                                                              VerticalAlignment="Center"/>
                                                                                    </Border>
                                                                                    <ControlTemplate.Triggers>
                                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                                            <Setter Property="Background" Value="#2B8E3F"/>
                                                                                            <Setter Property="BorderBrush" Value="#118938"/>
                                                                                        </Trigger>
                                                                                        <Trigger Property="IsPressed" Value="True">
                                                                                            <Setter Property="Background" Value="#0F7530"/>
                                                                                            <Setter Property="BorderBrush" Value="#0A5D23"/>
                                                                                        </Trigger>
                                                                                    </ControlTemplate.Triggers>
                                                                                </ControlTemplate>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                    </Style>
                                                                </Button.Style>
                                                            </Button>
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </DockPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
            <!-- Panel superpuesto de detalle -->
            <Grid x:Name="DetalleOverlay" Visibility="{Binding MostrarDetallePlan, Converter={StaticResource BooleanToVisibilityConverter}}" 
                  Background="#80000000">
                <Border Width="480" MaxHeight="620" Background="White" CornerRadius="8" Padding="18" 
                        HorizontalAlignment="Right" Margin="0,20,20,20" BorderBrush="#DDD" BorderThickness="1">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <DockPanel Margin="0,0,0,12">
                                <TextBlock Text="Detalle del Plan" FontWeight="SemiBold" FontSize="16" DockPanel.Dock="Left"/>
                                <Button Content="Cerrar" DockPanel.Dock="Right" Padding="10,4" Command="{Binding CerrarDetallePlanCommand}" />
                            </DockPanel>
                            <UniformGrid Columns="2" Rows="4" Margin="0,0,0,12">
                                <TextBlock Text="Código:" FontWeight="Bold"/>
                                <TextBlock Text="{Binding SelectedPlanDetalle.Codigo}"/>
                                <TextBlock Text="Equipo:" FontWeight="Bold"/>
                                <TextBlock Text="{Binding SelectedPlanDetalle.Nombre}"/>
                                <TextBlock Text="Asignado:" FontWeight="Bold"/>
                                <TextBlock Text="{Binding SelectedPlanDetalle.Sede}"/>
                                <TextBlock Text="Estado:" FontWeight="Bold"/>
                                <TextBlock Text="{Binding DetalleEstadoTexto}"/>
                                <TextBlock Text="Objetivo:" FontWeight="Bold"/>
                                <TextBlock Text="{Binding DetalleFechaObjetivo, StringFormat=d}"/>
                                <TextBlock Text="Ejecución:" FontWeight="Bold"/>
                                <TextBlock Text="{Binding DetalleFechaEjecucion, StringFormat=G}"/>
                                <TextBlock Text="Resumen:" FontWeight="Bold"/>
                                <TextBlock Text="{Binding DetalleResumen}" TextWrapping="Wrap"/>
                            </UniformGrid>
                            <TextBlock Text="Checklist" FontWeight="SemiBold" Margin="0,0,0,6"/>
                            <DataGrid ItemsSource="{Binding DetalleChecklist}" AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="True"
                                      HeadersVisibility="Column" RowHeaderWidth="0" GridLinesVisibility="None" Height="240">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="#" Binding="{Binding Id}" Width="40"/>
                                    <DataGridTextColumn Header="Ítem" Binding="{Binding Descripcion}" Width="*"/>
                                    <DataGridTextColumn Header="Estado" Binding="{Binding Estado}" Width="80"/>
                                    <DataGridTextColumn Header="Obs" Binding="{Binding Observacion}" Width="140"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Grid>
    </Border>
</UserControl>
