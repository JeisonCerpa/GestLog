<Window x:Class="GestLog.Views.Tools.GestionEquipos.GestionarPlanesDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:GestLog.Converters"
        Title="Gestión de Planes de Cronograma" 
        Height="600" Width="900"
        WindowStartupLocation="CenterOwner"
        Background="#FAFAFA">
    <Window.Resources>
        <converters:BooleanToStringConverter x:Key="BooleanToStringConverter" />
        <converters:DiaProgramadoToNombreDiaConverter x:Key="DiaProgramadoToNombreDiaConverter" />
        <converters:BooleanToColorConverter x:Key="BooleanToColorConverter" />

        <!-- Paleta y estilos coherentes con GestLog -->
        <SolidColorBrush x:Key="PrimaryBrush" Color="#118938"/>
        <SolidColorBrush x:Key="SecondaryBrush" Color="#2B8E3F"/>
        <SolidColorBrush x:Key="TextPrimaryBrush" Color="#504F4E"/>
        <Style x:Key="PrimaryButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="6" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="DangerButtonStyle" TargetType="Button" BasedOn="{StaticResource PrimaryButtonStyle}">
            <Setter Property="Background" Value="#C0392B"/>
        </Style>
        <Style x:Key="CardBorderStyle" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="BorderBrush" Value="#DDD"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect Color="#504F4E" BlurRadius="8" ShadowDepth="2" Opacity="0.08"/>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Encabezado rediseñado -->
        <Border Grid.Row="0" Style="{StaticResource CardBorderStyle}" Background="{StaticResource PrimaryBrush}" Padding="16" Margin="0,0,0,12">
            <DockPanel>
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                    <Border Background="White" Width="44" Height="44" CornerRadius="8" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="0,0,12,0">
                        <Image Source="/Assets/image001.ico" Width="28" Height="28" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock Text="Gestión de Planes de Cronograma" FontSize="18" FontWeight="SemiBold" Foreground="White"/>
                        <TextBlock Text="Crear, activar y eliminar planes de mantenimiento" FontSize="12" Foreground="#E6F5EA"/>
                    </StackPanel>
                </StackPanel>
                <TextBlock Text="{Binding StatusText, FallbackValue='Listo'}" DockPanel.Dock="Right" VerticalAlignment="Center" Foreground="White" FontSize="12" HorizontalAlignment="Right"/>
            </DockPanel>
        </Border>

        <!-- Lista de planes (tarjeta) -->
        <Border Grid.Row="1" Style="{StaticResource CardBorderStyle}">
            <ListView x:Name="PlanesListView" ItemsSource="{Binding Planes}" SelectionMode="Single">
                <ListView.View>
                    <GridView>
                        <GridViewColumn Header="Código Equipo" DisplayMemberBinding="{Binding CodigoEquipo}" Width="120"/>
                        <!-- Mostrar Nombre del equipo: priorizar navigation Equipo.NombreEquipo, si no existe mostrar CodigoEquipo -->
                        <GridViewColumn Header="Nombre Equipo" Width="180">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock>
                                        <TextBlock.Text>
                                            <PriorityBinding>
                                                <Binding Path="Equipo.NombreEquipo" />
                                                <Binding Path="CodigoEquipo" />
                                            </PriorityBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <!-- Mostrar Usuario Asignado: priorizar Equipo.UsuarioAsignado, si no existe usar Responsable del plan -->
                        <GridViewColumn Header="Usuario Asignado" Width="160">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock>
                                        <TextBlock.Text>
                                            <PriorityBinding>
                                                <Binding Path="Equipo.UsuarioAsignado" />
                                                <Binding Path="Responsable" />
                                            </PriorityBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>
                        <GridViewColumn Header="Día Programado" Width="120">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock>
                                        <TextBlock.Text>
                                            <MultiBinding StringFormat="{}{0} ({1})">
                                                <Binding Path="DiaProgramado"/>
                                                <Binding Path="DiaProgramado" Converter="{StaticResource DiaProgramadoToNombreDiaConverter}"/>
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>
                        <GridViewColumn Header="Estado" Width="80">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Activo, Converter={StaticResource BooleanToStringConverter}}" 
                                               Foreground="{Binding Activo, Converter={StaticResource BooleanToColorConverter}}"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>
                        <GridViewColumn Header="Fecha Creación" DisplayMemberBinding="{Binding FechaCreacion, StringFormat='dd/MM/yyyy'}" Width="100"/>
                    </GridView>
                </ListView.View>
            </ListView>
        </Border>

        <!-- Botones de acción centrados -->
        <StackPanel Grid.Row="2" Orientation="Vertical" HorizontalAlignment="Center" Margin="0,20,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="Editar" x:Name="BtnEditar" Style="{StaticResource PrimaryButtonStyle}" Padding="12,6" Margin="6" Click="EditarButton_Click"/>
                <Button Content="Activar/Desactivar" Style="{StaticResource PrimaryButtonStyle}" Padding="12,6" Margin="6" Click="ToggleActivoButton_Click"/>
                <Button Content="Eliminar" Style="{StaticResource DangerButtonStyle}" Padding="12,6" Margin="6" Click="EliminarButton_Click"/>
            </StackPanel>

            <!-- Panel de edición inline (oculto por defecto) -->
            <Border x:Name="EditPanel" Style="{StaticResource CardBorderStyle}" Visibility="Collapsed" Margin="0,12,0,0" Width="720">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*" />
                        <ColumnDefinition Width="1*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <StackPanel Orientation="Horizontal" Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2" Margin="8">
                        <StackPanel Margin="0,0,16,0">
                            <TextBlock Text="Código Equipo" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}"/>
                            <!-- Reemplazado TextBox por ComboBox que mostrará sólo equipos activos -->
                            <ComboBox x:Name="CmbEquipoEditar" Width="240"
                                      ItemsSource="{Binding EquiposActivos}"
                                      DisplayMemberPath="DisplayText"
                                      SelectedValuePath="Codigo"
                                      SelectedValue="{Binding SelectedEquipoEditarCodigo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                      IsEditable="True"
                                      IsTextSearchEnabled="False"
                                      ToolTip="Seleccione un equipo activo" />
                        </StackPanel>
                        <StackPanel Margin="0,0,16,0">
                            <TextBlock Text="Día programado" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}"/>
                            <ComboBox x:Name="CmbDiaEditar" Width="200" SelectedValuePath="Tag">
                                <ComboBoxItem Tag="1">1 - Lunes</ComboBoxItem>
                                <ComboBoxItem Tag="2">2 - Martes</ComboBoxItem>
                                <ComboBoxItem Tag="3">3 - Miércoles</ComboBoxItem>
                                <ComboBoxItem Tag="4">4 - Jueves</ComboBoxItem>
                                <ComboBoxItem Tag="5">5 - Viernes</ComboBoxItem>
                                <ComboBoxItem Tag="6">6 - Sábado</ComboBoxItem>
                                <ComboBoxItem Tag="7">7 - Domingo</ComboBoxItem>
                            </ComboBox>
                        </StackPanel>
                        <StackPanel>
                            <TextBlock Text="Responsable" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}"/>
                            <TextBox x:Name="TxtResponsableEditar" Width="240" />
                        </StackPanel>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="3" HorizontalAlignment="Right" Margin="8">
                        <Button Content="Guardar" x:Name="BtnGuardarEdicion" Style="{StaticResource PrimaryButtonStyle}" Width="120" Margin="8,0,0,0" Click="GuardarEdicionButton_Click"/>
                        <Button Content="Cancelar" x:Name="BtnCancelarEdicion" Style="{StaticResource DangerButtonStyle}" Width="120" Margin="8,0,0,0" Click="CancelarEdicionButton_Click"/>
                    </StackPanel>
                </Grid>
            </Border>
        </StackPanel>

        <!-- Estado y botón cerrar alineado a la derecha dentro de la línea inferior -->
        <Grid Grid.Row="3" Margin="0,20,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock x:Name="StatusTextBlock" Grid.Column="0" Text="Listo" VerticalAlignment="Center" Foreground="#666"/>
            <Button Grid.Column="1" Content="Cerrar" Padding="12,6" Style="{StaticResource PrimaryButtonStyle}" Background="#6C757D" Click="CerrarButton_Click" Margin="6,0,0,0"/>
        </Grid>
    </Grid>
</Window>
