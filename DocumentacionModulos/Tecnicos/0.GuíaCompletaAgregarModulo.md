# Guía simple para añadir un módulo a GestLog

Esta guía explica, con palabras sencillas, todo lo que necesitas para crear un módulo nuevo en GestLog. Incluye la estructura mínima, qué poner en cada archivo, ejemplos listos para copiar, cómo registrar el servicio en el contenedor (DI), cómo mostrar la tarjeta en Herramientas y una lista final de comprobación.

Índice
- Resumen rápido
- Estructura mínima
- Paso a paso fácil
- Qué escribir en cada archivo (ejemplos listos para pegar)
  - ViewModel
  - Model
  - Interface y Service
  - View (XAML)
- Registrar en DI (explicado simple)
- Añadir la card en Herramientas (pasos claros)
- Conceptos básicos (lifetimes, DbContext, repositorio) en lenguaje simple
- Tests simples
- Checklist final

---

Resumen rápido
1. Crea la carpeta: `Modules/MiModulo` con subcarpetas `ViewModels`, `Models`, `Interfaces`, `Services`, `Views`, `DocumentacionModulos`.
2. Crea los archivos básicos (ver ejemplos abajo).
3. Registra el servicio y el ViewModel en DI (Startup o Program).
4. Añade permiso y la card en `Herramientas` para abrir la vista.
5. Prueba la pantalla.

---

Estructura mínima (ejemplo)
- Modules/MiModulo/
  - ViewModels/MiModuloViewModel.cs
  - Models/MiModuloModel.cs
  - Interfaces/IMiModuloService.cs
  - Services/MiModuloService.cs
  - Views/MiModuloView.xaml
  - DocumentacionModulos/MiModulo-Usuario.md
  - README.md

---

Paso a paso fácil
1) Crea las carpetas.
2) Copia y pega los ejemplos de abajo en los archivos correspondientes.
3) Registra las clases en DI (ver sección Registro en DI).
4) Añade permiso y la card en Herramientas (ver sección Herramientas).
5) Ejecuta la app y prueba con un usuario que tenga el permiso.

---

Qué escribir en cada archivo (ejemplos listos para pegar)

1) ViewModels/MiModuloViewModel.cs
```csharp
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using System.Collections.ObjectModel;

public partial class MiModuloViewModel : ObservableObject
{
    [ObservableProperty]
    private string mensaje = "¡Bienvenido a Mi Módulo!";

    [ObservableProperty]
    private ObservableCollection<MiModuloModel> elementos = new();

    private readonly IMiModuloService _service;

    public MiModuloViewModel(IMiModuloService service)
    {
        _service = service;
        Cargar();
    }

    [RelayCommand]
    private void Cargar()
    {
        Elementos = new ObservableCollection<MiModuloModel>(_service.ObtenerElementos());
    }

    [RelayCommand]
    private void MostrarMensaje()
    {
        Mensaje = "Botón pulsado";
    }
}
```

Explicación simple: El ViewModel contiene datos que la vista muestra y acciones (comandos). Pide un servicio para obtener datos.

---

2) Models/MiModuloModel.cs
```csharp
public class MiModuloModel
{
    public int Id { get; set; }
    public string Nombre { get; set; }
    public string Descripcion { get; set; }
}
```
Explicación: Clase que representa cada elemento que verás en la pantalla.

---

3) Interfaces/IMiModuloService.cs
```csharp
using System.Collections.Generic;

public interface IMiModuloService
{
    List<MiModuloModel> ObtenerElementos();
}
```
Explicación: Define qué hace el servicio. Más tarde puedes añadir Guardar, Eliminar, ObtenerPorId.

---

4) Services/MiModuloService.cs (ejemplo simple en memoria)
```csharp
using System.Collections.Generic;

public class MiModuloService : IMiModuloService
{
    public List<MiModuloModel> ObtenerElementos()
    {
        return new List<MiModuloModel>
        {
            new MiModuloModel { Id = 1, Nombre = "Ejemplo", Descripcion = "Primer elemento" }
        };
    }
}
```
Explicación: Implementación sencilla que devuelve datos en memoria. Más adelante puedes conectar una base de datos.

---

5) Views/MiModuloView.xaml (WPF ejemplo)
```xml
<Window x:Class="Modules.MiModulo.Views.MiModuloView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Mi Módulo" Height="350" Width="500">
    <StackPanel Margin="10">
        <TextBlock Text="{Binding Mensaje}" FontSize="18" Margin="0,0,0,10" />
        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
            <Button Content="Cargar" Command="{Binding CargarCommand}" Width="80" />
            <Button Content="Mostrar" Command="{Binding MostrarMensajeCommand}" Width="80" Margin="10,0,0,0" />
        </StackPanel>
        <ListBox ItemsSource="{Binding Elementos}" DisplayMemberPath="Nombre" Height="180" />
    </StackPanel>
</Window>
```
Explicación: La vista enlaza a las propiedades y comandos del ViewModel.

---

Registrar en DI (explicado simple)
¿Qué significa? "Registrar en DI" quiere decir: decirle a la app qué clase usar cuando alguien pida una interfaz o un ViewModel. Se hace en `Startup.*.cs` o `Program.cs`.

Ejemplo simple para pegar:
```csharp
services.AddTransient<IMiModuloService, MiModuloService>();
services.AddTransient<MiModuloViewModel>();
```
Explicación: Con esto, cuando alguien pida `IMiModuloService` recibirá `MiModuloService`. Cuando pida `MiModuloViewModel`, el contenedor lo creará y le inyectará el servicio.

Notas sobre "Transiente/Scoped/Singleton" (muy simple):
- Transient: una instancia nueva cada vez.
- Scoped: una instancia compartida dentro de un "bloque de trabajo" (en WPF se crea manualmente).
- Singleton: una sola instancia para toda la aplicación.

Recomendación práctica para GestLog: ViewModels como Transient. Si usas DbContext, preferir Scoped y crear scope manual para operaciones con DB.

---

Añadir la card/panel en Herramientas (pasos claros)
1) Crear permiso identificador, ejemplo: `Herramientas.AccederMiModulo`.
2) Añadir un flag en `HerramientasViewModel` para controlar si se debe mostrar la card.

Ejemplo en `HerramientasViewModel`:
```csharp
[ObservableProperty]
private bool canAccessMiModulo;

private void RecalcularPermisos()
{
    CanAccessMiModulo = _currentUser.HasPermission("Herramientas.AccederMiModulo");
}
```
3) Añadir control en `HerramientasView.xaml` (copiar una card existente y cambiar bindings):
```xml
<Button Content="Mi Módulo"
        Click="BtnMiModulo_Click"
        Visibility="{Binding CanAccessMiModulo, Converter={StaticResource BooleanToVisibilityConverter}}" />
```
4) Implementar `BtnMiModulo_Click` siguiendo el patrón existente: crear ViewModel (desde DI), crear la vista, asignar DataContext y navegar.

Ejemplo simple del manejador (concepto):
```csharp
var serviceProvider = LoggingService.GetServiceProvider();
using var scope = serviceProvider.CreateScope();
var miVm = scope.ServiceProvider.GetRequiredService<MiModuloViewModel>();
var miView = new Modules.MiModulo.Views.MiModuloView { DataContext = miVm };
_mainWindow.NavigateToView(miView, "Mi Módulo");
```
Explicación: Resuelves el ViewModel con DI, creas la vista y la muestras.

---

Conceptos básicos (muy simple)
- DbContext / EF Core: es la forma de hablar con la base de datos. Primero trabajas con datos en memoria, luego conectas EF Core.
- Repositorio: es una clase con métodos como Obtener, Guardar, Borrar. Tu servicio usa el repositorio.
- Unit of Work / Transacción: agrupa varias acciones en una sola operación que se confirma o se deshace entera.

Si llegas a usar EF Core, añade la connection string en `appsettings.json` y registra el DbContext en Startup.

---

Tests simples
- Para probar el ViewModel, sustituye el servicio por un "mock" (falso) que devuelva datos.
- Ejemplo con xUnit + Moq:
```csharp
// Arrange
var mockService = new Mock<IMiModuloService>();
mockService.Setup(s => s.ObtenerElementos()).Returns(new List<MiModuloModel>{ new MiModuloModel{ Id = 1, Nombre = "X" }});

// Act
var vm = new MiModuloViewModel(mockService.Object);

// Assert
Assert.Single(vm.Elementos);
Assert.Equal("X", vm.Elementos.First().Nombre);
```
Explicación: Así compruebas que el ViewModel hace lo que debe sin tocar la base de datos.

---

Checklist final antes de crear PR
- [ ] Carpeta `Modules/MiModulo` creada con archivos.
- [ ] Servicios y ViewModels registrados en DI.
- [ ] Permiso `Herramientas.AccederMiModulo` registrado y comprobado.
- [ ] Card añadida en `HerramientasView` y `HerramientasViewModel`.
- [ ] Documentación de usuario corta en `DocumentacionModulos`.
- [ ] README técnico con permisos y dependencias.
- [ ] Tests mínimos para ViewModel y servicio.

---

Siguientes pasos que puedo hacer por ti
- Crear físicamente el módulo ejemplo (`Modules/MiModulo`) con los archivos.
- Generar un script PowerShell para crear la plantilla automáticamente.
- Reescribir la guía completa manteniendo ejemplos técnicos por separado (si prefieres aún más simple).

Si quieres que haga cualquiera de estas acciones, dime cuál y lo hago.

---

Fin de la guía completa. Gracias.
